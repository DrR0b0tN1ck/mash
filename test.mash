[[[def dot-named: save #1.dot; !exec dot -Tpdf #1.dot -o #1.pdf; print \includegraphics{#1.pdf}]]]
[[[def dot: @dot-named($1)]]]
[[[def pdflatex: !exec pdflatex -file-line-error -halt-on-error #1]]]
[[[def latexdoc: save #1.tex; @pdflatex(#1); !exec bibtex #1; @pdflatex(#1); @pdflatex(#1); !keep #1.pdf]]]

[[[def bibentry: save bib-$1]]]

[[[@latexdoc(test)
  \documentclass[11pt]{article}
  \usepackage{graphicx}
  
  \begin{document}
    Here are some Fibonacci numbers:
    [[[filter python; push
      a = 0
      b = 1
      for i in range(1, 10):
        c = a + b
        a = b
        b = c
        print c
    ]]]

    Here are some squares:
    [[[save $1.py; !exec python $1.py > $2.tex; print \input{$2.tex}
      for i in range(1, 10):
        print i*i
    ]]]

  
    [[[@bibentry
      @book{bcd,
        author = {abc and def},
        title = {Title of a Book},
        publisher = {xyz},
        year = 2016
      }
    ]]]
    
    Here's a graph~\cite{bcd}:
    \begin{center}
    [[[@dot
      graph {
        rankdir=LR
        d -- e
        d -- f
        d -- g
        e -- h
      }
    ]]]
    \end{center}

    Here's another graph.
    \begin{center}
    [[[@dot-named(g2)
      graph { rankdir=LR; a -- b -- c -- d; b -- d}
    ]]]
    \end{center}

    More details are in some other document~\cite{abc}.
    [[[@bibentry
      @book{abc,
        author = {abc and def},
        title = {Title of a Another Book},
        publisher = {xyz},
        year = 2017
      }
    ]]]

    [[[read bib-*; save test.bib]]]

    \bibliographystyle{plain}
    \bibliography{test}

  \end{document}

]]]

